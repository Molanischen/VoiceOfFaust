//-----------------------------------------------
// Classic vocoder synthesis
//-----------------------------------------------

vocoderFund(freq)=
    fund(freq,vocoderOctave);

vocoderOsc(freq) =
    stereosupersawpulse(vocoderN,vocoderFund(freq),freq,vocoderDetune,vocoderMix,vocoderSawPulse,vocoderDuty);

volFilter(c,f,v,q) =
    f:resonbp(c:min((SR/2)-10),Q,v):resonbp(c:min((SR/2)-10),Q,compensate)
    with {
    //compensate for one filter:
    //compensate = (tanh((1/(vocoderQ:min(1)))/2));
    //compensate for two filters:
    //pow(vslider("[-1]comp",	1, 1, 20, 0.001)):
    //compensate = ((1/(((vocoderQ:min(7))/7):pow(hslider("[-1]comp",	1, 0.001, 1, 0))))-1)*(hslider("[-1]comp",	1, 1, 2000, 0.001)):hbargraph("[-1]compensate", 0, 99)+1;
    //compensate = 1;// ((1/(vocoderQ:min(7)))/7);
    //compensate = (1/(((vocoderQ:min(2))/2)))*((((vocoderQ*0.5:min(1)*-1)+1)*10)+1);
    //gain = dezip(v*compensate, minline);
    //gain = (v*compensate);
	/*bandFreq =       25*pow(2,(band+1)*(9/bandsNumb));*/
	/*BW = (bandFreq - 25*pow(2,(band)*(9/bandsNumb)))*bwRatio;*/
	/*bandQ = bandFreq/BW;*/
    Q = q;
    BP1= 1.766;//1/hslider("[-1]bp1",	0, 0, 1, 0.001); //1.766
    BP2 =9.43;//1/hslider("[-1]bp2",	0, 0, 1, 0.001); //9.43
    FAC1 = 1;//hslider("[-1]fac1",	1, 1, 30, 0.001);//1
    FAC2 = 1.7;//hslider("[-1]fac2",	1, 1, 30, 0.001);//1.7
    FAC3 = 4;//hslider("[-1]fac3",	1, 1, 30, 0.001);//4
    com = 1/(Q/49);
    compensate =
          (((com*FAC1),(com<BP1)):*),
          ((((com-BP1)*FAC2+FAC1*BP1),((com>=BP1)&(com<=BP2))):*),
          ((((com-BP2)*FAC3+((BP2-BP1)*FAC2)+FAC1*BP1),(com>BP2)):*)
          :>_+1;
    };

volFilterBank(Oscilator,q, nrBands)=
    par(i, nrBands, volFilter(_,_,Volume,q));

/*volFilterBank(Center1,Center2,Center3,Center4,Center5,Center6,Center7,Center8,Center9,Center10,Center11,Center12,Center13,Center14,Center15,Center16,Volume1,Volume2,Volume3,Volume4,Volume5,Volume6,Volume7,Volume8,Volume9,Volume10,Volume11,Volume12,Volume13,Volume14,Volume15,Volume16,Oscilator,q)=*/
    /*volFilter(Center1,Oscilator,Volume1,q),*/
    /*volFilter(Center2,Oscilator,Volume2,q),*/
    /*volFilter(Center3,Oscilator,Volume3,q),*/
    /*volFilter(Center4,Oscilator,Volume4,q),*/
    /*volFilter(Center5,Oscilator,Volume5,q),*/
    /*volFilter(Center6,Oscilator,Volume6,q),*/
    /*volFilter(Center7,Oscilator,Volume7,q),*/
    /*volFilter(Center8,Oscilator,Volume8,q),*/
    /*volFilter(Center9,Oscilator,Volume9,q),*/
    /*volFilter(Center10,Oscilator,Volume10,q),*/
    /*volFilter(Center11,Oscilator,Volume11,q),*/
    /*volFilter(Center12,Oscilator,Volume12,q),*/
    /*volFilter(Center13,Oscilator,Volume13,q),*/
    /*volFilter(Center14,Oscilator,Volume14,q),*/
    /*volFilter(Center15,Oscilator,Volume15,q),*/
    /*volFilter(Center16,Oscilator,Volume16,q)*/
    /*//resonhp(Center16,q,1)*/
    /*;*/

StereoVolFilterBank(nrBands)= interleave(nrBands,4):par(i, nrBands, volFilter);


/*StereoVolFilterBank(Center1,Center2,Center3,Center4,Center5,Center6,Center7,Center8,Center9,Center10,Center11,Center12,Center13,Center14,Center15,Center16,Volume1,Volume2,Volume3,Volume4,Volume5,Volume6,Volume7,Volume8,Volume9,Volume10,Volume11,Volume12,Volume13,Volume14,Volume15,Volume16,freq,q)=*/
    /*vocoderOsc(freq)<:bus(nrBands):*/
    /*volFilter(Center1,_,Volume1,q),*/
    /*volFilter(Center2,_,Volume2,q),*/
    /*volFilter(Center3,_,Volume3,q),*/
    /*volFilter(Center4,_,Volume4,q),*/
    /*volFilter(Center5,_,Volume5,q),*/
    /*volFilter(Center6,_,Volume6,q),*/
    /*volFilter(Center7,_,Volume7,q),*/
    /*volFilter(Center8,_,Volume8,q),*/
    /*volFilter(Center9,_,Volume9,q),*/
    /*volFilter(Center10,_,Volume10,q),*/
    /*volFilter(Center11,_,Volume11,q),*/
    /*volFilter(Center12,_,Volume12,q),*/
    /*volFilter(Center13,_,Volume13,q),*/
    /*volFilter(Center14,_,Volume14,q),*/
    /*volFilter(Center15,_,Volume15,q),*/
    /*volFilter(Center16,_,Volume16,q)*/
    /*;*/



vocoderCenters(freq) =
    VocoderFreqs(vocoderBottom,vocoderTop):(par(i,nrBands, _,freq * vocoderOctave:*:min(SR/2))):cross(nrBands);

StereoVocoder(audio,freq)=
    (vocoderCenters(freq),(vocoderOsc(freq)<:bus(nrBands)),analizer(voice(audio),freq), (vocoderQ<:bus(nrBands))):StereoVolFilterBank(nrBands):vocoderMixer:par(i, 2, _*0.01):WidePanner(vocoderWidth);


//process(audio) = StereoVolFilterBank;
//vocoderOsc(PitchTracker(audio));


