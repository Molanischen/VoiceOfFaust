//-----------------------------------------------
// Classic vocoder synthesis
//-----------------------------------------------

vocoderFund(freq,index) =
    fund(freq,index,vocoderOctave);

vocoderOsc(freq,index) =
  ( par(i,2,(noises(2,i)*sqrt((vocoderOscNoise))))
  ,(stereosupersawpulse(vocoderN,vocoderFund(freq,index),freq,vocoderDetune,vocoderMix,vocoderSawPulse,vocoderDuty):par(i,2,_*sqrt((1-vocoderOscNoise))))
  ):> inputRouter(inputRoutingEnabled)
  with {
    inputRouter(0)= bus2<:bus(nrBands);
    inputRouter(1) =
    bus2 <:(
       (par(i, 2, (xfadeSelector(inputRouting,0):dezip) *_) :butterfly(2): par(i,2,_<:bus(nrBands/2)) )
      ,(par(i, 2, (xfadeSelector(inputRouting,1):dezip) *_) :butterfly(2)<:interleave(nrBands/2,2))
      ,(par(i, 2, (xfadeSelector(inputRouting,2):dezip) *_) :butterfly(2)<:bus(nrBands))
      ,(par(i, 2, (xfadeSelector(inputRouting,3):dezip) *_) <:bus(nrBands))
      ,(par(i, 2, (xfadeSelector(inputRouting,4):dezip) *_) :( (_<:bus(nrBands/nrOutChan)) ,(_<:bus(nrBands-(nrBands/nrOutChan))) ))
      ,(par(i, 2, (xfadeSelector(inputRouting,5):dezip) *_) :butterfly(2)<:butterfly(nrBands))
      /*,(par(i, 2, xfadeSelector(inputRouting,6):dezip) *_) :butterfly(2):( (_<:bus(nrBands/nrOutChan)) ,(_<:bus(nrBands-(nrBands/nrOutChan))) ))*/
      /*,(par(i, 2, xfadeSelector(inputRouting,7):dezip) *_) :butterfly(2)<:interleave(2,nrBands/2))*/
      /*,(par(i, 2, (inputRouting==7) *_) <:interleave(2,nrBands/2):hadamard(nrBands))*/
      /*,(par(i, 2, (inputRouting==8) *_) <:hadamard(nrBands))*/
      /*,(par(i, 2, (inputRouting==9) *_) <:hadamard(nrBands):interleave(2,nrBands/2))*/
      // ==3 hademar?
      ):>bus(nrBands);
      };

volFilter(f,prevC,c,v,q) =
    f:chooseResonBP(stableFilters,c:min((SR/2)-10),Q,v):chooseResonBP(stableFilters,c:min((SR/2)-10),Q,compensate)
    with {
    //compensate for one filter:
    //compensate = (tanh((1/(vocoderQ:min(1)))/2));
    //compensate for two filters:
    //pow(vslider("[-1]comp",	1, 1, 20, 0.001)):
    //compensate = ((1/(((vocoderQ:min(7))/7):pow(hslider("[-1]comp",	1, 0.001, 1, 0))))-1)*(hslider("[-1]comp",	1, 1, 2000, 0.001)):hbargraph("[-1]compensate", 0, 99)+1;
    //compensate = 1;// ((1/(vocoderQ:min(7)))/7);
    //compensate = (1/(((vocoderQ:min(2))/2)))*((((vocoderQ*0.5:min(1)*-1)+1)*10)+1);
    //gain = dezip(v*compensate, minline);
    //gain = (v*compensate);
	/*bandFreq =       25*pow(2,(band+1)*(9/bandsNumb));*/
	/*BW = (bandFreq - 25*pow(2,(band)*(9/bandsNumb)))*bwRatio;*/
	/*bandQ = bandFreq/BW;*/
    Q = ((((c-(prevC*autoQ)):max(20))*q)/(c:max(20)))*(1+(2*autoQ));
    BP1= 1.766;//1/hslider("[-1]bp1",	0, 0, 1, 0.001); //1.766
    BP2 =9.43;//1/hslider("[-1]bp2",	0, 0, 1, 0.001); //9.43
    FAC1 = 1;//hslider("[-1]fac1",	1, 1, 30, 0.001);//1
    FAC2 = 1.7;//hslider("[-1]fac2",	1, 1, 30, 0.001);//1.7
    FAC3 = 4;//hslider("[-1]fac3",	1, 1, 30, 0.001);//4
    com = 1/(Q/49);
    compensate =
          (((com*FAC1),(com<BP1)):*),
          ((((com-BP1)*FAC2+FAC1*BP1),((com>=BP1)&(com<=BP2))):*),
          ((((com-BP2)*FAC3+((BP2-BP1)*FAC2)+FAC1*BP1),(com>BP2)):*)
          :>_+1;
    };

// StereoVolFilterBank(nrBands,enableFeedback)
StereoVolFilterBank(nrBands,0) = StereoVolFilterBankNoFeedback(nrBands);
StereoVolFilterBank(nrBands,1) = StereoVolFilterBankWithFeedback(nrBands);



StereoVolFilterBankNoFeedback(nrBands)= (AutosatArray(enableFilterAutosat),bus(nrBands*4)):(interleave(nrBands,5):par(i, nrBands, volFilter));

StereoVolFilterBankWithFeedback(nrBands)= (((interleave(nrBands,2):par(i,nrBands,+):AutosatArray(enableFilterAutosat)),bus(nrBands*4)):interleave(nrBands,5):par(i, nrBands, volFilter))~FBpath with {
  FBpath = bus(nrBands)<:(lowerFB,selfFB,higherFB,allFB):>bus(nrBands);
  lowerFB=
    bus(nrBands)
      <:((0,par(i,nrBands,selector(i-1,nrBands)))
        :((bus(nrBands),(VocoderLinArrayChooser(lowerFBbottom,lowerFBmid,lowerFBband,lowerFBtop,para):par(i,nrBands,pow(3):dezip))):(interleave(nrBands,2)):par(i,nrBands,*)));
  selfFB = ((bus(nrBands),(VocoderLinArrayChooser(selfFBbottom,selfFBmid,selfFBband,selfFBtop,para):par(i,nrBands,pow(3):dezip))):(interleave(nrBands,2)):par(i,nrBands,*));
  higherFB=  bus(nrBands)<:((par(i,nrBands,selector(i+1,nrBands)),0):((bus(nrBands),(VocoderLinArrayChooser(higherFBbottom,higherFBmid,higherFBband,higherFBtop,para):par(i,nrBands,pow(3):dezip))):(interleave(nrBands,2)):par(i,nrBands,*)));
  allFB   = (bus(nrBands)<:par(i,nrBands,par(j,nrBands,_*(i!=j)):>_):>((bus(nrBands),(VocoderLinArrayChooser(allFBbottom,allFBmid,allFBband,allFBtop,para):par(i,nrBands,pow(3):dezip))):(interleave(nrBands,2)):par(i,nrBands,*)));
    };

AutosatArray(0) = bus(nrBands);
AutosatArray(1) =
  (
    (
       bus(nrBands),
       (VocoderLinArrayChooser(autoSatBottom,autoSatMid,autoSatBand,autoSatTop,para):dezipBands)
    )
       :interleave(nrBands,2)
  )
    :par(i,nrBands,bus(2)<:(((selector(0,2):addDC(i))*(selector(1,2):db2linear)):autoSat)*((selector(1,2)/8):autoSat*-8:db2linear));
     addDC(band)=_+(VocoderLinArrayChooser(autoSatDCbottom,autoSatDCmid,autoSatDCband,autoSatDCtop,para):selector(band,nrBands):pow(3)*64:dezip);


vocoderCenters(freq) =
    VocoderFreqsChooser(vocoderBottom,vocoderMid,vocoderBand,vocoderTop,para):(par(i,nrBands, _,freq * vocoderOctave:*:min(SR/2):dezip));


endGainCompare(audio,freq) = (bus(nrOutChan),(voice(audio,index)<:bus(nrOutChan))):interleave(nrOutChan,2):par(i,nrOutChan,gainCompareElement);

StereoVocoder(audio,freq,index,fidelity) =
           ((vocoderOsc(freq,index)<:bus(nrBands))
           ,(vocoderCenters(freq)<:((bus(nrBands)<:((50:max(vocoderBottom*freq*vocoderOctave)),par(i,nrBands,selector(i-1,nrBands)))),(bus(nrBands))))
           ,analizer(voice(audio,index),freq,fidelity,enableDeEsser)
           ,(VocoderLinArrayChooser(vocoderQbottom,vocoderQmid,vocoderQband,vocoderQtop,para):dezipBands))
           :StereoVolFilterBank(nrBands,enableFeedback)
           :gainCompare(audio,index,fidelity,freq,enableGainCompare)
           :vocoderMixer(ambisonicsOn,outputRoutingEnabled,0)
           // :endGainCompare(audio,freq)
           :postProc(nrOutChan,ambisonicsOn,enableAutosat,volume*select2(gainCompEnable,0.001,0.02),vocoderWidth);
