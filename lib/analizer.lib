//-----------------------------------------------
// vocoder analizer
//-----------------------------------------------

subLevel(audio) = voice(audio):gate_mono(threshold-15,0,0.1,0.05):lowpass(3,300):amp_follower_ud(0.003,0.005)*4:tanh;

//subLevel(audio) = audio:lowpass(3,300):amp_follower_ud((vslider("up", 0, 0, 1, 0)*0.1),(vslider("down", 0, 0, 1, 0.001)*0.1))*6:tanh;

//analizerCenters(freq) = VocoderFreqs(0.853553,128):(par(i,nrBands, _,freq:*:min(SR/2)));

analizerCenters(freq) = VocoderFreqs(analizerBottom ,analizerTop):(par(i,nrBands, _,freq:*:min(SR/2)));

//amp_follower_ud params set for minimal distortion
//also sounds cool to vary between this and 0

bandEnv=resonbp(analizerQ,1):amp_follower_ud(0.002,0.004);

analizers=
interleave(nrBands,4):par(i, nrBands,(autoQresonBP:amp_follower_ud(0.002 ,0.004)));

autoQresonBP(f,prevC,c,q) =
    f:resonbp(c:min((SR/2)-10),Q,1):resonbp(c:min((SR/2)-10),Q,compensate*0.2)
    with {
      Q = ((((c-(prevC*autoQ)):max(20))*q)/(c:max(20)))*(1+(2*autoQ));
      BP1= 1.766;//1/hslider("[-1]bp1",	0, 0, 1, 0.001); //1.766
      BP2 =9.43;//1/hslider("[-1]bp2",	0, 0, 1, 0.001); //9.43
      FAC1 = 1;//hslider("[-1]fac1",	1, 1, 30, 0.001);//1
      FAC2 = 1.7;//hslider("[-1]fac2",	1, 1, 30, 0.001);//1.7
      FAC3 = 4;//hslider("[-1]fac3",	1, 1, 30, 0.001);//4
      com = 1/(Q/49);
      compensate =
            (((com*FAC1),(com<BP1)):*),
            ((((com-BP1)*FAC2+FAC1*BP1),((com>=BP1)&(com<=BP2))):*),
            ((((com-BP2)*FAC3+((BP2-BP1)*FAC2)+FAC1*BP1),(com>BP2)):*)
            :>_+1;
    };

/*analizers(audio,freq1,freq2,freq3,freq4,freq5,freq6,freq7,freq8,freq9,freq10,freq11,freq12,freq13,freq14,freq15,freq16)=*/
/*audio<:*/
        /*(*/
        /*bandEnv(freq1),*/
        /*bandEnv(freq2),*/
        /*bandEnv(freq3),*/
        /*bandEnv(freq4),*/
        /*bandEnv(freq5),*/
        /*bandEnv(freq6),*/
        /*bandEnv(freq7),*/
        /*bandEnv(freq8),*/
        /*bandEnv(freq9),*/
        /*bandEnv(freq10),*/
        /*bandEnv(freq11),*/
        /*bandEnv(freq12),*/
        /*bandEnv(freq13),*/
        /*bandEnv(freq14),*/
        /*bandEnv(freq15),*/
        /*bandEnv(freq16)*/
/*);*/

analizer(audio,freq)=
(
  (audio<:bus(nrBands))
  ,(analizerCenters(freq)<:((bus(nrBands)<:((50:max(vocoderBottom*freq*vocoderOctave)),par(i,nrBands,selector(i-1,nrBands)))),(bus(nrBands))))
  ,(analizerQ<:bus(nrBands))
):analizers;
