
//-----------------------------------------------
// FOF vocoder synthesis
//-----------------------------------------------

//fofCenters=     par(i,nrBands,   pow((pow((fofTop/fofBottom),1/15)),i)*fofBottom);
// fofFund(freq) =
//     fund(freq,fofOctave);

fofCenters(freq) = centers(freq,fofVocoderGroup);
// fofCenters(freq) = centers(1,fofVocoderGroup):par(i, nrBands, pow(2)*freq); // original values
/*fofSkirts  = VocoderFreqs(fofSkirtBottom,fofSkirtTop);*/
/*fofDecays  = VocoderFreqs(fofDecayBottom,fofDecayTop);*/
fofSkirts(freq)  =
  VocoderFreqsChooser(fofSkirtBottom,fofSkirtMid,fofSkirtBand,fofSkirtTop,para)
  :par(i, nrBands, _*t(4)*(SR/freq*SR)):dezipBands;
fofDecays  = VocoderLinArrayChooser(fofDecayBottom,fofDecayMid,fofDecayBand,fofDecayTop,para):dezipBands;
// fofPhases = VocoderLinArrayChooser(fofPhaseBottom,fofPhaseMid,fofPhaseBand,fofPhaseTop,para):dezipBands;
fofOctavations = VocoderLinArrayChooser(fofOctavationBottom,fofOctavationMid,fofOctavationBand,fofOctavationTop,para):dezipBands;

fofNoises(i,freq,enablePhasenoise,enablePhaseNoiseFilter) = phaseNoises(i,freq,enablePhasenoise,enablePhaseNoiseFilter,fofVocoderGroup);


fofOscs=
    interleave(nrBands,7):
    par(i, nrBands, (fof));

// fofvocoder(audio,freq,doubleOscs)
fofvocoder(audio,freq,index,fidelity,0)=
  //the noises part is to make a different (low)freq modulation for each osc.
  //noises(nrBands,0):smooth(tau2pole(32))
  //"(i+1)*" is to make each band different
  (fofNoises(0,freq,enablePhasenoise,enablePhaseNoiseFilter),fofCenters(freq),(multiK<:bus(nrBands)),(freq<:bus(nrBands)),fofSkirts(freq),fofDecays,fofOctavations)
  :fofOscs
  :gainNormalise
  :((analizer(voice(audio,index),freq,fidelity,enableDeEsser),par(i, nrBands, _)):interleave(nrBands,2):par(i, nrBands,*))
  :vocoderMixer(ambisonicsOn,outputRoutingEnabled,doubleOscs)
  :postProc(nrOutChan,ambisonicsOn,enableAutosat,volume*0.1,1)
with {
  multiK = lf_rawsaw(SR/freq*multi);
};

fofvocoder(audio,freq,index,fidelity,1)=
  //the noises part is to make a different (low)freq modulation for each osc.
  //noises(nrBands,0):smooth(tau2pole(32))
  //"(i+1)*" is to make each band different
  par(i,nrOutChan
    ,(fofNoises(i+1,freq,enablePhasenoise,enablePhaseNoiseFilter),fofCenters(freq),(multiK<:bus(nrBands)),(freq<:bus(nrBands)),fofSkirts(freq),fofDecays,fofOctavations)
    :fofOscs
    : gainNormalise
    :((analizer(voice(audio,index),freq,fidelity,enableDeEsser),par(i, nrBands, _)):interleave(nrBands,2):par(i, nrBands,*))
  )
  :vocoderMixer(ambisonicsOn,outputRoutingEnabled,doubleOscs)
  :postProc(nrOutChan,ambisonicsOn,enableAutosat,volume*0.1,1)
with {
  multiK = lf_rawsaw(SR/freq*multi);
};